name: Test matrix - Preparation
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        options:
          - 'ENV1'
          - 'ENV4'
          - 'ENV1,ENV2,ENV3'
          - 'ENV1,ENV3'
        type: choice
jobs:
  prep-matrix:
    name: Prepare Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: |
          ${{ steps.matrix.outputs.matrix }}
    steps:
      - run: |
          envs="${{ inputs.environment }}"
          matrix=$(echo $envs | jq -cR 'split(",") | .[]' | jq -s '[.[] | { environment: . }]' | jq -c '{ include: . }')
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
          echo $matrix

  build:
    runs-on: ubuntu-latest
    needs: [prep-matrix]
    strategy:
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}
    steps:
      - name: step1.1
        run: echo "123456" > ${{ vars.FILE_PART1 }}

      - name: Generate artifact release 
        uses: actions/upload-artifact@v3
        with:
          name: ${{ vars.FILE_PART1 }}
          path: ${{ vars.FILE_PART1 }}

      - name: step1.2
        run: echo "567890" > ${{ vars.FILE_PART2 }}

      - name: Generate artifact release 
        uses: actions/upload-artifact@v3
        with:
          name: ${{ vars.FILE_PART2 }}
          path: ${{ vars.FILE_PART2 }}
